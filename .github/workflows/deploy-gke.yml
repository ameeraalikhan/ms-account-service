name: CI/CD - Deploy Account Service to GKE

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: account-service

  # GCP
  GCP_PROJECT_ID: unique-ellipse-464414-j6
  GCP_REGION: us-central1
  GKE_CLUSTER: autopilot-cluster-1
  GCR_IMAGE: gcr.io/unique-ellipse-464414-j6/account-service

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v3

      - name: ‚òï Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: üß™ Build Spring Boot App
        run: mvn clean package --file pom.xml

      - name: üê≥ Build Docker Image
        run: |
          docker build --no-cache -t $IMAGE_NAME:${{ github.sha }} .
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest

      - name: üîê Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: üê≥ Tag and Push Docker Image to GCR
        run: |
          gcloud auth configure-docker
          docker tag $IMAGE_NAME:${{ github.sha }} $GCR_IMAGE:${{ github.sha }}
          docker tag $IMAGE_NAME:${{ github.sha }} $GCR_IMAGE:latest
          docker push $GCR_IMAGE:${{ github.sha }}
          docker push $GCR_IMAGE:latest

      - name: üîß Replace image placeholder in manifest
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$GCR_IMAGE:${{ github.sha }}|" account-service-full.yaml

      - name: ‚öôÔ∏è Get GKE Credentials
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER \
            --region $GCP_REGION --project $GCP_PROJECT_ID

      - name: üöÄ Deploy to GKE
        run: |
          kubectl apply -f account-service-full.yaml
          kubectl rollout restart deployment account-service
