name: CI/CD - Deploy to OpenShift

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  IMAGE_NAME: account-service
  IMAGE_TAG: ${{ github.sha }}
  IMAGE_FULL: image-registry.openshift-image-registry.svc:5000/${{ secrets.OPENSHIFT_NAMESPACE }}/account-service:${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: â˜• Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21

      - name: ğŸ§ª Build Spring Boot App
        run: mvn clean package --file pom.xml

      - name: ğŸ³ Build Docker Image
        run: |
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker tag $IMAGE_NAME:$IMAGE_TAG $IMAGE_FULL

      - name: ğŸ› ï¸ Install OpenShift CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/oc/latest/linux/oc.tar.gz -o oc.tar.gz
          tar -xvf oc.tar.gz
          sudo mv oc /usr/local/bin/
          oc version --client

      - name: ğŸ” Login to OpenShift
        run: |
          echo "${{ secrets.OPENSHIFT_TOKEN }}" | \
          oc login --token=$(cat -) --server=${{ secrets.OPENSHIFT_URL }} --insecure-skip-tls-verify=true

          oc whoami

          oc whoami -t | docker login -u openshift --password-stdin \
            image-registry.openshift-image-registry.svc:5000

      - name: ğŸ“¤ Push to OpenShift Registry
        run: docker push $IMAGE_FULL

      - name: ğŸ”§ Replace image in manifest
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$IMAGE_FULL|" account-service.yaml

      - name: ğŸš€ Deploy to OpenShift
        run: |
          oc apply -f account-service.yaml -n ${{ secrets.OPENSHIFT_NAMESPACE }}
          oc rollout restart deployment/account-service -n ${{ secrets.OPENSHIFT_NAMESPACE }}
